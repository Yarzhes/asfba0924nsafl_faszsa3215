# Data Models

This document specifies the data structures used throughout the trading system.

## SubSignal
A `SubSignal` is generated by a single trading strategy. It represents a potential trade signal before it is combined with signals from other strategies.

| Field | Type | Description |
|---|---|---|
| `ts` | int | The timestamp of when the signal was generated. |
| `symbol` | str | The trading symbol for which the signal is generated. |
| `tf` | str | The timeframe (e.g., "5m", "1h") on which the signal is based. |
| `strategy_id` | str | The unique identifier for the strategy that produced the signal. |
| `direction` | "LONG" \| "SHORT" \| "FLAT" | The direction of the proposed trade. `FLAT` indicates a neutral or exit signal. |
| `confidence_calibrated` | float | The strategy's confidence in the signal, calibrated to a probability (0 to 1). |
| `reasons` | dict | A dictionary containing strategy-specific data that justifies the signal. |

**Example:**
```json
{
  "ts": 1672531200,
  "symbol": "BTC/USDT",
  "tf": "1h",
  "strategy_id": "trend_pullback",
  "direction": "LONG",
  "confidence_calibrated": 0.75,
  "reasons": {
    "ema_fast": 25000,
    "ema_slow": 24800,
    "rsi": 65
  }
}
```

## EnsembleDecision
An `EnsembleDecision` is the result of combining multiple `SubSignal` instances. It represents the final trading decision after considering all strategy inputs and applying veto logic.

| Field | Type | Description |
|---|---|---|
| `ts` | int | The timestamp of the ensemble decision. |
| `symbol` | str | The trading symbol. |
| `tf` | str | The timeframe. |
| `decision` | "LONG" \| "SHORT" \| "FLAT" | The final trading decision from the ensemble. |
| `confidence` | float | The combined confidence of the ensemble in the decision. |
| `subsignals` | list[SubSignal] | The list of individual `SubSignal` objects that were part of this ensemble evaluation. |
| `vote_detail` | dict | Contains details about the voting process, including `weighted_sum`, `agree` (number of signals in agreement), `total` (total signals), and `profile` (e.g., "trend", "mr"). |
| `vetoes` | list[str] | A list of reasons for any vetoes that were applied. |

## PortfolioState
The `PortfolioState` captures the current state of the entire trading portfolio, including equity, open positions, and risk exposure.

| Field | Type | Description |
|---|---|---|
| `ts` | int | The timestamp of the portfolio state snapshot. |
| `equity` | float | The total current equity of the portfolio. |
| `positions` | dict[symbol -> Position] | A dictionary mapping symbols to their current position details (`side`, `size`, `entry`, `risk`, `cluster`). |
| `exposure` | dict | A nested dictionary detailing risk exposure by `symbol`, `cluster`, and `net` (long/short), as well as `margin_used`. |

## RiskEvent
A `RiskEvent` is logged whenever a risk management rule is triggered.

| Field | Type | Description |
|---|---|---|
| `ts` | int | The timestamp of the risk event. |
| `symbol` | str | The symbol associated with the event, if applicable. |
| `reason` | str | A short, machine-readable string identifying the reason for the event (e.g., "MAX_CLUSTER_RISK"). |
| `action` | "VETO" \| "DOWNSIZE" \| "COOLDOWN" | The action taken by the risk management system. |
| `detail` | dict | A dictionary containing contextual information about the event. |